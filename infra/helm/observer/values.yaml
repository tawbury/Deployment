# infra/helm/observer/values.yaml
# ============================================================
# Observer Helm Chart - Source of Truth
# ============================================================
# 이 파일은 ConfigMap, Deployment, Probes의 단일 설정 원천입니다.
# Secret 값은 SealedSecret으로 별도 관리됩니다.
# ============================================================

# ------------------------------------------------------------
# 1. Image Configuration
# ------------------------------------------------------------
image:
  repository: ghcr.io/tawbury/observer
  tag: build-20260213-101127
  pullPolicy: Always

imagePullSecrets:
  - name: ghcr-secret

# ------------------------------------------------------------
# 2. Application Environment (→ ConfigMap)
# ------------------------------------------------------------
app:
  # 실행 환경
  env: production           # production | development | staging
  logLevel: INFO            # DEBUG | INFO | WARNING | ERROR
  logFormat: json           # json | text
  timezone: Asia/Seoul

  # 서비스 포트
  servicePort: 8000

  # 운영 모드
  standalone: true          # OBSERVER_STANDALONE=1

  # Config Loader 설정 (shared/config.py 연동)
  runMode: container        # local | container - config loader가 사용
  deploymentMode: kubernetes  # docker | kubernetes | dev - 배포 모드 감지

# ------------------------------------------------------------
# 3. Observer Runtime Settings (→ ConfigMap)
# ------------------------------------------------------------
observer:
  # Collector 활성화
  trackAEnabled: true
  trackBEnabled: true     # Scalp Collector (Track B) - WebSocket real-time

  # Collector 설정
  swingIntervalMinutes: 5
  scalpMaxSlots: 41
  
  # 장중 시간 (KST)
  tradingStartTime: "09:00"
  tradingEndTime: "15:30"
  
  # 마켓 설정
  market: kr_stocks
  
  # Universe/Symbol 설정
  minSymbolCount: 2500
  minPrice: 4000

# ------------------------------------------------------------
# 4. Database Configuration (→ ConfigMap, non-secret only)
# ------------------------------------------------------------
database:
  host: postgres
  port: 5432
  name: observer
  # user/password는 Secret으로 주입 (postgres.secretName)

# ------------------------------------------------------------
# 4.1 PostgreSQL StatefulSet Configuration
# ------------------------------------------------------------
postgres:
  enabled: true
  name: postgres

  image:
    repository: postgres
    tag: "15-alpine"
    pullPolicy: IfNotPresent

  # Secret containing POSTGRES_USER and POSTGRES_PASSWORD
  # Uses obs-db-secret from SealedSecrets (keys: DB_USER, DB_PASSWORD)
  secretName: obs-db-secret

  resources:
    requests:
      memory: "256Mi"
      cpu: "100m"
    limits:
      memory: "512Mi"
      cpu: "500m"

  persistence:
    enabled: true
    claimName: observer-db-pvc
    size: 10Gi
    static:
      enabled: true
      path: /opt/platform/runtime/observer/DB
      nodeName: obs-prod-arm

  probes:
    liveness:
      initialDelaySeconds: 30
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 6
    readiness:
      initialDelaySeconds: 5
      periodSeconds: 5
      timeoutSeconds: 3
      failureThreshold: 3

# ------------------------------------------------------------
# 5. Paths Configuration (→ ConfigMap)
# ------------------------------------------------------------
paths:
  # PVC 마운트 경로 (관리용 기본 경로)
  runtimeRoot: /opt/platform/runtime/observer
  dataDir: /opt/platform/runtime/observer/data
  logDir: /opt/platform/runtime/observer/logs
  configDir: /opt/platform/runtime/observer/config
  systemLogDir: /opt/platform/runtime/observer/logs/system
  maintenanceLogDir: /opt/platform/runtime/observer/logs/maintenance
  snapshotDir: /opt/platform/runtime/observer/data/universe
  tokenCacheDir: /opt/platform/runtime/observer/data/cache
  # 백업 경로
  backupDir: /opt/platform/runtime/observer/data/backups
  archiveDir: /opt/platform/runtime/observer/data/backups/archives
  manifestDir: /opt/platform/runtime/observer/data/backups/manifests
  # 앱 호환성 symlink (/app/* → /opt/platform/runtime/observer/*)
  appRoot: /app

# ------------------------------------------------------------
# 6. Secrets Reference (Individual SealedSecrets)
# ------------------------------------------------------------
# SealedSecrets 기반 GitOps 표준 구성
# 각 Secret은 bitnami/sealed-secrets로 암호화되어 Git에 저장
secrets:
  # DB 자격증명 (PostgreSQL 초기화 + Observer 앱)
  db:
    enabled: true
    name: obs-db-secret
    optional: false
  # KIS API 자격증명 (한국투자증권)
  kis:
    enabled: true
    name: obs-kis-sealed-secret
    optional: false
  # Kiwoom API 자격증명 (선택적)
  kiwoom:
    enabled: false
    name: obs-kiwoom-secret
    optional: true

# ------------------------------------------------------------
# 7. Probes Configuration
# ------------------------------------------------------------
probes:
  # Startup Probe: ConfigMap 로딩 및 초기화 완료 확인
  startup:
    enabled: true
    path: /health
    initialDelaySeconds: 10
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 30   # 최대 150초 대기 (30 * 5)
  
  # Liveness Probe: 메인 루프 살아있는지 확인
  liveness:
    enabled: true
    path: /health
    initialDelaySeconds: 30
    periodSeconds: 20
    timeoutSeconds: 5
    failureThreshold: 5
  
  # Readiness Probe: 외부 의존성 연결 완료 확인
  readiness:
    enabled: true
    path: /ready
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

# ------------------------------------------------------------
# 8. Resources
# ------------------------------------------------------------
resources:
  requests:
    memory: "512Mi"
    cpu: "250m"
  limits:
    memory: "1Gi"
    cpu: "1000m"

# ------------------------------------------------------------
# 9. Security Context
# ------------------------------------------------------------
securityContext:
  pod:
    fsGroup: 1000
  container:
    runAsUser: 1000
    runAsGroup: 1000
    runAsNonRoot: true
    readOnlyRootFilesystem: true
    allowPrivilegeEscalation: false

# ------------------------------------------------------------
# 10. Persistence (PVC)
# ------------------------------------------------------------
persistence:
  data:
    enabled: true
    # type: hostPath (사용 안함 - Static PV로 대체)
    # hostPath: /var/lib/observer
    claimName: observer-data-pvc
    size: 20Gi
    static:
      enabled: true
      path: /opt/platform/runtime/observer/data
      nodeName: obs-prod-arm
  logs:
    enabled: true
    # type: hostPath (사용 안함 - Static PV로 대체)
    # hostPath: /var/lib/observer/logs
    claimName: observer-logs-pvc
    size: 5Gi
    static:
      enabled: true
      path: /opt/platform/runtime/observer/logs
      nodeName: obs-prod-arm
  # config는 hostPath 사용 (symbols 파일 영속성)
  config:
    hostPath: /opt/platform/runtime/observer/config

  # Backups (Archives & Manifests) - Explicit Persistence
  backups:
    archives:
      enabled: true
      claimName: observer-backup-archives-pvc
      size: 10Gi
      static:
        enabled: true
        path: /opt/platform/runtime/observer/data/backups/archives
        nodeName: obs-prod-arm
    manifests:
      enabled: true
      claimName: observer-backup-manifests-pvc
      size: 1Gi
      static:
        enabled: true
        path: /opt/platform/runtime/observer/data/backups/manifests
        nodeName: obs-prod-arm

# ------------------------------------------------------------
# 11. Service
# ------------------------------------------------------------
service:
  type: ClusterIP
  port: 8000
  targetPort: 8000

# ------------------------------------------------------------
# 12. Replicas
# ------------------------------------------------------------
replicaCount: 1
