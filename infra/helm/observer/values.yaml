# infra/helm/observer/values.yaml
# ============================================================
# Observer Helm Chart - Source of Truth
# ============================================================
# 이 파일은 ConfigMap, Deployment, Probes의 단일 설정 원천입니다.
# Secret 값은 SealedSecret으로 별도 관리됩니다.
# ============================================================

# ------------------------------------------------------------
# 1. Image Configuration
# ------------------------------------------------------------
image:
  repository: ghcr.io/tawbury/observer
  tag: build-20260207-211207
  pullPolicy: Always

imagePullSecrets:
  - name: ghcr-secret

# ------------------------------------------------------------
# 2. Application Environment (→ ConfigMap)
# ------------------------------------------------------------
app:
  # 실행 환경
  env: production           # production | development | staging
  logLevel: INFO            # DEBUG | INFO | WARNING | ERROR
  logFormat: json           # json | text
  timezone: Asia/Seoul
  
  # 서비스 포트
  servicePort: 8000
  
  # 운영 모드
  standalone: true          # OBSERVER_STANDALONE=1

# ------------------------------------------------------------
# 3. Observer Runtime Settings (→ ConfigMap)
# ------------------------------------------------------------
observer:
  # Collector 설정
  swingIntervalMinutes: 5
  scalpMaxSlots: 41
  
  # 장중 시간 (KST)
  tradingStartTime: "09:00"
  tradingEndTime: "15:30"
  
  # 마켓 설정
  market: kr_stocks
  
  # Universe/Symbol 설정
  minSymbolCount: 2500
  minPrice: 4000

# ------------------------------------------------------------
# 4. Database Configuration (→ ConfigMap, non-secret only)
# ------------------------------------------------------------
database:
  host: postgres
  port: 5432
  name: observer
  # user/password는 Secret으로 주입 (obs-db-secret)

# ------------------------------------------------------------
# 5. Paths Configuration (→ ConfigMap)
# ------------------------------------------------------------
paths:
  # 컨테이너 내부 경로 (PVC volumeMount와 일치해야 함)
  runtimeRoot: /app
  dataDir: /app/data
  logDir: /app/logs
  configDir: /app/config
  systemLogDir: /app/logs/system
  maintenanceLogDir: /app/logs/maintenance
  snapshotDir: /app/data/universe
  tokenCacheDir: /app/data/cache
  # Backward compatibility symlink target (사용자 편의)
  legacyRoot: /opt/platform/runtime/observer

# ------------------------------------------------------------
# 6. Secrets Reference (SealedSecret에서 생성됨)
# ------------------------------------------------------------
secrets:
  db:
    name: obs-db-sealed-secret
    optional: false
  kis:
    name: obs-kis-sealed-secret
    optional: false
  kiwoom:
    name: obs-kiwoom-sealed-secret
    optional: true         # 향후 활성화

# ------------------------------------------------------------
# 7. Probes Configuration
# ------------------------------------------------------------
probes:
  # Startup Probe: ConfigMap 로딩 및 초기화 완료 확인
  startup:
    enabled: true
    path: /health
    initialDelaySeconds: 10
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 30   # 최대 150초 대기 (30 * 5)
  
  # Liveness Probe: 메인 루프 살아있는지 확인
  liveness:
    enabled: true
    path: /health
    initialDelaySeconds: 30
    periodSeconds: 20
    timeoutSeconds: 5
    failureThreshold: 5
  
  # Readiness Probe: 외부 의존성 연결 완료 확인
  readiness:
    enabled: true
    path: /ready
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

# ------------------------------------------------------------
# 8. Resources
# ------------------------------------------------------------
resources:
  requests:
    memory: "512Mi"
    cpu: "250m"
  limits:
    memory: "1Gi"
    cpu: "1000m"

# ------------------------------------------------------------
# 9. Security Context
# ------------------------------------------------------------
securityContext:
  pod:
    fsGroup: 1000
  container:
    runAsUser: 1000
    runAsGroup: 1000
    runAsNonRoot: true
    readOnlyRootFilesystem: true
    allowPrivilegeEscalation: false

# ------------------------------------------------------------
# 10. Persistence (PVC)
# ------------------------------------------------------------
persistence:
  data:
    enabled: true
    claimName: observer-data-pvc
    size: 20Gi
  logs:
    enabled: true
    claimName: observer-logs-pvc
    size: 5Gi
  # config는 hostPath 사용 (symbols 파일 영속성)
  config:
    hostPath: /opt/platform/runtime/observer/config

# ------------------------------------------------------------
# 11. Service
# ------------------------------------------------------------
service:
  type: ClusterIP
  port: 8000
  targetPort: 8000

# ------------------------------------------------------------
# 12. Replicas
# ------------------------------------------------------------
replicaCount: 1